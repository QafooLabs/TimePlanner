{% extends 'QafooTimePlannerBundle::layout.html.twig' %}

{% block css %}
    {{parent()}}
    <link href="/vendor/typeahead/typeahead.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>
            Jobs
            <div class="pull-right planning-nav">
                {% set date=view.year ~ "-" ~ view.month ~ "-01" %}
                <form class="navbar-form navbar-left">
                    <div class="form-group">
                        <input type="hidden" name="month" value="{{date|date_modify("-1 month")|date("n")}}">
                        <input type="hidden" name="year" value="{{date|date_modify("-1 month")|date("Y")}}">
                        <button type="submit" class="btn btn-default">
                            <span class="glyphicon glyphicon-step-backward" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
                <form class="navbar-form navbar-left" action="{{path("qafoo.time_planner.time_planning.overview")}}" method="GET">
                    <div class="form-group">
                        <select name="month" class="form-control">
                        {% for month in range(1, 12) %}
                            <option {% if month == view.month %}selected{% endif %} value="{{month}}">
                                {{("2015-" ~ month)|date("F")}}
                            </option>
                        {% endfor %}
                        </select>
                        <select name="year" class="form-control">
                        {% for year in range(2010, (("now"|date("Y")) + 1)) %}
                            <option {% if year == view.year %}selected{% endif %} value="{{year}}">
                                {{year}}
                            </option>
                        {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">
                            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
                {% set nextMonth=view.year ~ "-" ~ (view.month) ~ "-01" %}
                <form class="navbar-form navbar-left">
                    <div class="form-group">
                        <input type="hidden" name="month" value="{{date|date_modify("+1 month")|date("n")}}">
                        <input type="hidden" name="year" value="{{date|date_modify("+1 month")|date("Y")}}">
                        <button type="submit" class="btn btn-default">
                            <span class="glyphicon glyphicon-step-forward" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
            </div>
        </h2>
        <table class="table table-striped table-hover table-condensed">
            <thead>
                <tr>
                    <th>{{"Customer"|trans()}}</th>
                    <th>{{"Project"|trans()}}</th>
                    <th>{{"Revenue"|trans()}}</th>
                    <th><abbr title="{{"Minimum Person Days"|trans()}}">{{"Min"|trans()}}</abbr></th>
                    <th><abbr title="{{"Maximum Person Days"|trans()}}">{{"Max"|trans()}}</abbr></th>
                {% for user in view.users %}
                    <th>{% include "QafooUserBundle:User:small.html.twig" with {user: user} %}</th>
                {% endfor %}
                    <th>{{"Invoice"|trans()}}</th>
                    <th>{{"Comment"|trans()}}</th>
                    <th>{{"Options"|trans()}}</th>
                </tr>
            </thead>
            <tbody>
            {% for job in view.jobs %}
                {% include "QafooTimePlannerBundle:TimePlanning:tableRow.html.twig" with {job: job, year: view.year, month: view.month, highlight: view.highlight} %}
            {% endfor %}
                <tr>
                    <form method="POST" class="form-inline" action="{{path("qafoo.time_planner.time_planning.create")}}">
                        <td><input type="text" class="form-control input-sm" required name="customer" placeholder="{{"Customer"|trans()}}"></td>
                        <td><input type="text" class="form-control input-sm" required name="project" placeholder="{{"Project"|trans()}}"></td>
                        <td><input autocomplete="off" type="text" class="form-control number input-sm" required name="revenue" placeholder="{{"Revenue"|trans()}}"></td>
                        <td><input autocomplete="off" type="text" class="form-control number input-sm" min="0" required name="pt.min" placeholder="{{"Min. PT"|trans()}}"></td>
                        <td><input autocomplete="off" type="text" class="form-control number input-sm" min="0" required name="pt.max" placeholder="{{"Max. PT"|trans()}}"></td>
                        <td colspan="{{view.users|length() + 2}}"><input type="text" autocomplete="off" class="form-control input-sm" name="comment" placeholder="{{"Comment"|trans()}}"></td>
                        <td class="number">
                            <input type="hidden" name="year" value="{{view.year}}">
                            <input type="hidden" name="month" value="{{view.month}}">
                            <button class="btn btn-default btn-sm">
                                <span class="glyphicon glyphicon-save" aria-label="Store"></span>
                            </button>
                        </td>
                    </form>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2">Sum</td>
                    <td class="number">{{view.sum.expectedRevenue|number_format(2)}} €</td>
                    <td class="number">{{view.sum.personDays.minimum}}</td>
                    <td class="number">{{view.sum.personDays.maximum}}</td>
                {% for user in view.users %}
                    <td class="number {% if user.login == view.user.login %}active{% endif %}">
                        {{view.sum.assignees[user.login].days|default(0)}}
                    </td>
                {% endfor %}
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="3">{{"Vacations"|trans()}}</td>
                {% set vacationSum = 0 %}
                {% for user in view.users %}
                    {% set vacationSum = vacationSum + view.vacationDays[user.login]|length() %}
                {% endfor %}
                    <td class="number">{{vacationSum}}</td>
                    <td class="number">{{vacationSum}}</td>
                {% for user in view.users %}
                    <td class="number {% if user.login == view.user.login %}active{% endif %}">
                        {{view.vacationDays[user.login]|length()}}
                    </td>
                {% endfor %}
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <th colspan="2">Result</th>
                    {% set value = (view.sum.expectedRevenue - 25700) %}
                    <th class="number {% if value < 0 %}text-danger danger{% elseif value > 0 %}text-success{% endif %}">{{value|number_format(2)}} €</th>
                    {% set value = (view.availableWorkDays * view.users|length()) - view.sum.personDays.minimum - vacationSum %}
                    <th class="number {% if value < 0 %}text-danger danger{% endif %}">{{value}}</th>
                    {% set value = (view.availableWorkDays * view.users|length()) - view.sum.personDays.maximum - vacationSum %}
                    <th class="number {% if value < 0 %}text-danger warning{% endif %}">{{value}}</th>
                {% for user in view.users %}
                    {% set value = view.availableWorkDays - view.sum.assignees[user.login].days - view.vacationDays[user.login]|length()|default(0) %}
                    <th class="number
                        {% if value < 0 %}text-danger danger{% elseif user.login == view.user.login %}active{% endif %}">
                        {{value}}
                    </th>
                {% endfor %}
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{parent()}}
    <script src="/vendor/typeahead/typeahead.bundle.js"></script>
    <script type="text/javascript">
    var customers = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            limit: 5,
            prefetch: {
                url: '{{path("qafoo.time_planner.time_planning.customers")}}',
                filter: function(list) {
                    return $.map(list, function(customer) {return {name: customer};});
                }
            }
        }),
        projects = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            limit: 5,
            prefetch: {
                url: '{{path("qafoo.time_planner.time_planning.projects")}}',
                filter: function(list) {
                    return $.map(list, function(project) {return {name: project};});
                }
            }
        });
     
    customers.initialize();
    projects.initialize();
    $('input[name="customer"]').typeahead(null, {
        name: 'customer',
        displayKey: 'name',
        source: customers.ttAdapter()
    });
    $('input[name="project"]').typeahead(null, {
        name: 'project',
        displayKey: 'name',
        source: projects.ttAdapter()
    });
    </script>
{% endblock %}
